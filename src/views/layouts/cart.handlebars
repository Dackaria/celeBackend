{{!-- views/cart.handlebars --}}
<h1>Cart</h1>
<ul id="cart-products">
    {{#each cart.products}}
        <li data-id="{{this.id}}">
            <h2>{{this.title}}</h2>
            <p>Price: ${{this.price}}</p>
            <p>Quantity: <span class="product-quantity">{{this.quantity}}</span></p>
            <button class="add-product">Add More</button>
            <button class="remove-product">Remove One</button>
        </li>
    {{/each}}
</ul>
<p>Total: $<span id="cart-total">{{cart.total}}</span></p>

<script>
    const cartId = "{{cart._id}}"; // Assuming cartId is available in the template

    document.querySelectorAll('.add-product').forEach(button => {
        button.addEventListener('click', async (event) => {
            const productElement = event.target.closest('li');
            const productId = productElement.getAttribute('data-id');
            const quantityElement = productElement.querySelector('.product-quantity');
            const newQuantity = parseInt(quantityElement.textContent) + 1;

            try {
                const response = await fetch(`/api/carts/${cartId}/products/${productId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ quantity: newQuantity })
                });

                if (response.ok) {
                    const data = await response.json();
                    quantityElement.textContent = newQuantity;
                    document.getElementById('cart-total').textContent = data.newTotal;
                } else {
                    console.error('Failed to update product quantity');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        });
    });

    document.querySelectorAll('.remove-product').forEach(button => {
        button.addEventListener('click', async (event) => {
            const productElement = event.target.closest('li');
            const productId = productElement.getAttribute('data-id');
            const quantityElement = productElement.querySelector('.product-quantity');
            const newQuantity = parseInt(quantityElement.textContent) - 1;

            if (newQuantity < 1) return;

            try {
                const response = await fetch(`/api/carts/${cartId}/products/${productId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ quantity: newQuantity })
                });

                if (response.ok) {
                    const data = await response.json();
                    quantityElement.textContent = newQuantity;
                    document.getElementById('cart-total').textContent = data.newTotal;
                } else {
                    console.error('Failed to update product quantity');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        });
    });
</script>
